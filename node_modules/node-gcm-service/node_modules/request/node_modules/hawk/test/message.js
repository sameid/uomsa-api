// Load modules

var Url = require('url');
var Lab = require('lab');
var Hoek = require('hoek');
var Hawk = require('../lib');


// Declare internals

var internals = {***REMOVED***;


// Test shortcuts

var expect = Lab.expect;
var before = Lab.before;
var after = Lab.after;
var describe = Lab.experiment;
var it = Lab.test;


describe('Hawk', function () {

    var credentialsFunc = function (id, callback) {

        var credentials = {
            id: id,
            key: 'werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn',
            algorithm: (id === '1' ? 'sha1' : 'sha256'),
            user: 'steve'
        ***REMOVED***;

        return callback(null, credentials);
    ***REMOVED***;

    it('should generate an authorization then successfully parse it', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {***REMOVED***, function (err, credentials) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal('steve');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on mismatching host', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            Hawk.server.authenticateMessage('example1.com', 8080, 'some message', auth, credentialsFunc, {***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('Bad mac');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on stale timestamp', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, { localtimeOffsetMsec: 100000 ***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('Stale timestamp');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on invalid authorization', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;
            delete auth.id;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, {***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('Invalid authorization');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on bad hash', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message1', auth, credentialsFunc, {***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('Bad message hash');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on nonce error', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, credentialsFunc, { nonceFunc: function (nonce, ts, callback) { callback (new Error('kaboom')); ***REMOVED*** ***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('Invalid nonce');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on credentials error', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            var errFunc = function (id, callback) {

                callback(new Error('kablooey'));
            ***REMOVED***;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, errFunc, {***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('kablooey');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on missing credentials', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            var errFunc = function (id, callback) {

                callback();
            ***REMOVED***;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, errFunc, {***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('Unknown credentials');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on invalid credentials', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            var errFunc = function (id, callback) {

                callback(null, {***REMOVED***);
            ***REMOVED***;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, errFunc, {***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('Invalid credentials');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail authorization on invalid credentials algorithm', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.exist;

            var errFunc = function (id, callback) {

                callback(null, { key: '123', algorithm: '456' ***REMOVED***);
            ***REMOVED***;

            Hawk.server.authenticateMessage('example.com', 8080, 'some message', auth, errFunc, {***REMOVED***, function (err, credentials) {

                expect(err).to.exist;
                expect(err.message).to.equal('Unknown algorithm');
                done();
            ***REMOVED***);
        ***REMOVED***);
    ***REMOVED***);

    it('should fail on missing host', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var auth = Hawk.client.message(null, 8080, 'some message', { credentials: credentials ***REMOVED***);
            expect(auth).to.not.exist;
            done();
        ***REMOVED***);
    ***REMOVED***);

    it('should fail on missing credentials', function (done) {

        var auth = Hawk.client.message('example.com', 8080, 'some message', {***REMOVED***);
        expect(auth).to.not.exist;
        done();
    ***REMOVED***);

    it('should fail on invalid algorithm', function (done) {

        credentialsFunc('123456', function (err, credentials) {

            var creds = Hoek.clone(credentials);
            creds.algorithm = 'blah';
            var auth = Hawk.client.message('example.com', 8080, 'some message', { credentials: creds ***REMOVED***);
            expect(auth).to.not.exist;
            done();
        ***REMOVED***);
    ***REMOVED***);
***REMOVED***);
