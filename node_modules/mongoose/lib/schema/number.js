/*!
 * Module requirements.
 */

var SchemaType = require('../schematype')
  , CastError = SchemaType.CastError
  , utils = require('../utils')
  , Document

/**
 * Number SchemaType constructor.
 *
 * @param {String***REMOVED*** key
 * @param {Object***REMOVED*** options
 * @inherits SchemaType
 * @api private
 */

function SchemaNumber (key, options) {
  SchemaType.call(this, key, options, 'Number');
***REMOVED***;

/*!
 * Inherits from SchemaType.
 */

SchemaNumber.prototype.__proto__ = SchemaType.prototype;

/**
 * Required validator for number
 *
 * @api private
 */

SchemaNumber.prototype.checkRequired = function checkRequired (value, doc) {
  if (SchemaType._isRef(this, value, doc, true)) {
    return null != value;
  ***REMOVED*** else {
    return typeof value == 'number' || value instanceof Number;
  ***REMOVED***
***REMOVED***;

/**
 * Sets a minimum number validator.
 *
 * ####Example:
 *
 *     var s = new Schema({ n: { type: Number, min: 10 ***REMOVED***)
 *     var M = db.model('M', s)
 *     var m = new M({ n: 9 ***REMOVED***)
 *     m.save(function (err) {
 *       console.error(err) // validator error
 *       m.n = 10;
 *       m.save() // success
 *     ***REMOVED***)
 *
 * @param {Number***REMOVED*** value minimum number
 * @return {SchemaType***REMOVED*** this
 * @api public
 */

SchemaNumber.prototype.min = function (value) {
  if (this.minValidator) {
    this.validators = this.validators.filter(function (v) {
      return 'min' != v[1];
    ***REMOVED***);
  ***REMOVED***

  if (value != null) {
    this.validators.push([this.minValidator = function (v) {
      return v === null || v >= value;
    ***REMOVED***, 'min']);
  ***REMOVED***

  return this;
***REMOVED***;

/**
 * Sets a maximum number validator.
 *
 * ####Example:
 *
 *     var s = new Schema({ n: { type: Number, max: 10 ***REMOVED***)
 *     var M = db.model('M', s)
 *     var m = new M({ n: 11 ***REMOVED***)
 *     m.save(function (err) {
 *       console.error(err) // validator error
 *       m.n = 10;
 *       m.save() // success
 *     ***REMOVED***)
 *
 * @param {Number***REMOVED*** maximum number
 * @return {SchemaType***REMOVED*** this
 * @api public
 */

SchemaNumber.prototype.max = function (value) {
  if (this.maxValidator) {
    this.validators = this.validators.filter(function(v){
      return 'max' != v[1];
    ***REMOVED***);
  ***REMOVED***

  if (value != null) {
    this.validators.push([this.maxValidator = function(v){
      return v === null || v <= value;
    ***REMOVED***, 'max']);
  ***REMOVED***

  return this;
***REMOVED***;

/**
 * Casts to number
 *
 * @param {Object***REMOVED*** value value to cast
 * @param {Document***REMOVED*** doc document that triggers the casting
 * @param {Boolean***REMOVED*** init
 * @api private
 */

SchemaNumber.prototype.cast = function (value, doc, init) {
  if (SchemaType._isRef(this, value, doc, init)) {
    // wait! we may need to cast this to a document

    if (null == value) {
      return value;
    ***REMOVED***

    // lazy load
    Document || (Document = require('./../document'));

    if (value instanceof Document) {
      value.$__.wasPopulated = true;
      return value;
    ***REMOVED***

    // setting a populated path
    if ('number' == typeof value) {
      return value;
    ***REMOVED*** else if (Buffer.isBuffer(value) || !utils.isObject(value)) {
      throw new CastError('number', value, this.path);
    ***REMOVED***

    // Handle the case where user directly sets a populated
    // path to a plain object; cast to the Model used in
    // the population query.
    var path = doc.$__fullPath(this.path);
    var owner = doc.ownerDocument ? doc.ownerDocument() : doc;
    var pop = owner.populated(path, true);
    var ret = new pop.options.model(value);
    ret.$__.wasPopulated = true;
    return ret;
  ***REMOVED***

  var val = value && value._id
    ? value._id // documents
    : value;

  if (!isNaN(val)){
    if (null === val) return val;
    if ('' === val) return null;
    if ('string' == typeof val) val = Number(val);
    if (val instanceof Number) return val
    if ('number' == typeof val) return val;
    if (val.toString && !Array.isArray(val) &&
        val.toString() == Number(val)) {
      return new Number(val)
    ***REMOVED***
  ***REMOVED***

  throw new CastError('number', value, this.path);
***REMOVED***;

/*!
 * ignore
 */

function handleSingle (val) {
  return this.cast(val)
***REMOVED***

function handleArray (val) {
  var self = this;
  return val.map(function (m) {
    return self.cast(m)
  ***REMOVED***);
***REMOVED***

SchemaNumber.prototype.$conditionalHandlers = {
    '$lt' : handleSingle
  , '$lte': handleSingle
  , '$gt' : handleSingle
  , '$gte': handleSingle
  , '$ne' : handleSingle
  , '$in' : handleArray
  , '$nin': handleArray
  , '$mod': handleArray
  , '$all': handleArray
***REMOVED***;

/**
 * Casts contents for queries.
 *
 * @param {String***REMOVED*** $conditional
 * @param {any***REMOVED*** [value]
 * @api private
 */

SchemaNumber.prototype.castForQuery = function ($conditional, val) {
  var handler;
  if (arguments.length === 2) {
    handler = this.$conditionalHandlers[$conditional];
    if (!handler)
      throw new Error("Can't use " + $conditional + " with Number.");
    return handler.call(this, val);
  ***REMOVED*** else {
    val = this.cast($conditional);
    return val == null ? val : val
  ***REMOVED***
***REMOVED***;

/*!
 * Module exports.
 */

module.exports = SchemaNumber;
