module.exports = preferredEncodings;
preferredEncodings.preferredEncodings = preferredEncodings;

function parseAcceptEncoding(accept) {
  var acceptableEncodings;

  if (accept) {
    acceptableEncodings = accept.split(',').map(function(e) {
      return parseEncoding(e.trim());
    ***REMOVED***);
  ***REMOVED*** else {
    acceptableEncodings = [];
  ***REMOVED***

  if (!acceptableEncodings.some(function(e) {
    return e && e.encoding === 'identity';
  ***REMOVED***)) {
    acceptableEncodings.push({
      encoding: 'identity',
      q: 0.1
    ***REMOVED***);
  ***REMOVED***

  return acceptableEncodings.filter(function(e) {
    return e && e.q > 0;
  ***REMOVED***);
***REMOVED***

function parseEncoding(s) {
  var match = s.match(/^\s*(\S+?)\s*(?:;(.*))?$/);

  if (!match) return null;

  var encoding = match[1];
  var q = 1;
  if (match[2]) {
    var params = match[2].split(';');
    for (var i = 0; i < params.length; i ++) {
      var p = params[i].trim().split('=');
      if (p[0] === 'q') {
        q = parseFloat(p[1]);
        break;
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***

  return {
    encoding: encoding,
    q: q
  ***REMOVED***;
***REMOVED***

function getEncodingPriority(encoding, accepted) {
  return (accepted.filter(function(a) {
    return specify(encoding, a);
  ***REMOVED***).sort(function (a, b) {
    // revsort
    return a.q === b.q ? 0 : a.q > b.q ? -1 : 1;
  ***REMOVED***)[0] || {q:0***REMOVED***).q;
***REMOVED***

function specify(encoding, spec) {
  if (spec.encoding === '*' || spec.encoding === encoding) {
    return spec;
  ***REMOVED***
***REMOVED***

function preferredEncodings(accept, provided) {
  accept = parseAcceptEncoding(accept || '');
  if (provided) {
    return provided.map(function(type) {
      return [type, getEncodingPriority(type, accept)];
    ***REMOVED***).filter(function(pair) {
      return pair[1] > 0;
    ***REMOVED***).sort(function(a, b) {
      // revsort
      return a[1] === b[1] ? 0 : a[1] > b[1] ? -1 : 1;
    ***REMOVED***).map(function(pair) {
      return pair[0];
    ***REMOVED***);
  ***REMOVED*** else {
    return accept.sort(function (a, b) {
      // revsort
      return a.q < b.q ? 1 : -1;
    ***REMOVED***).map(function(type) {
      return type.encoding;
    ***REMOVED***);
  ***REMOVED***
***REMOVED***
