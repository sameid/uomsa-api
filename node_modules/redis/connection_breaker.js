var net = require('net');

var proxyPort = 6379;
var counter = 0;

function breaker(conn) {
    conn.end();
    conn.destroy();
***REMOVED***

var server = net.createServer(function(conn) {
    counter++;
    var proxyConn = net.createConnection({
        port: proxyPort
    ***REMOVED***);
    conn.pipe(proxyConn);
    proxyConn.pipe(conn);
    proxyConn.on('end', function() {
        conn.end();
    ***REMOVED***);
    conn.on('end', function() {
        proxyConn.end();
    ***REMOVED***);
    conn.on('close', function() {
        proxyConn.end();
    ***REMOVED***);
    proxyConn.on('close', function() {
        conn.end();
    ***REMOVED***);
    proxyConn.on('error', function() {
        conn.end();
    ***REMOVED***);
    conn.on('error', function() {
        proxyConn.end();
    ***REMOVED***);

    setTimeout(breaker.bind(null, conn), Math.floor(Math.random() * 2000));
***REMOVED***);
server.listen(6479);

var redis = require('./');

var port = 6479;

var client = redis.createClient(6479, 'localhost');

function iter() {
    var k = "k" + Math.floor(Math.random() * 10);
    var coinflip = Math.random() > 0.5;
    if (coinflip) {
        client.set(k, k, function(err, resp) {
            if (!err && resp !== "OK") {
                console.log("Unexpected set response " + resp);
            ***REMOVED***
        ***REMOVED***);
    ***REMOVED*** else {
        client.get(k, function(err, resp) {
            if (!err) {
                if (k !== resp) {
                    console.log("Key response mismatch: " + k + " " + resp);
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***);
    ***REMOVED***
***REMOVED***

function iters() {
    for (var i = 0; i < 100; ++i) {
        iter();
    ***REMOVED***
    setTimeout(iters, 10);
***REMOVED***

client.on("connect", function () {
    iters();
***REMOVED***);

client.on("error", function (err) {
    console.log("Client error " + err);
***REMOVED***);
